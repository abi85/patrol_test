workflows:
  ios-integration-test:
    name: iOS Integration Test
    instance_type: linux_x2
    max_build_duration: 120
    environment:
      vars:
        FLUTTER_VERSION: 3.19.0
        XCODE_WORKSPACE: "Runner.xcworkspace"
        XCODE_SCHEME: "Runner" 
      flutter: stable
      xcode: latest
      cocoapods: default
    triggering:
      events:  
        - push
    scripts:
      - name: Setup Flutter and Patrol
        script: |
          # Install Flutter
          git clone https://github.com/flutter/flutter.git -b stable
          export PATH="$PATH:$HOME/flutter/bin"
          flutter config --no-analytics
          
          # Setup iOS deployment tools
          sudo gem install cocoapods
          
          # Install Patrol CLI
          flutter pub global activate patrol_cli
          export PATH="$PATH:$HOME/.pub-cache/bin"
          
          # Print versions for verification
          flutter --version
          dart --version
          patrol --version

      - name: Prepare iOS Environment
        script: |
          # Install Xcode command line tools
          xcode-select --install || true
          
          # Accept Xcode licenses
          sudo xcodebuild -license accept
          
          # Setup iOS simulators
          xcrun simctl delete unavailable
          xcrun simctl create patrol_test_simulator \
            com.apple.CoreSimulator.SimDeviceType.iPhone-15 \
            com.apple.CoreSimulator.SimRuntime.iOS-16-4

      - name: Get Flutter packages
        script: |
          flutter pub get
          dart pub global activate patrol_cli
          
      - name: Install CocoaPods
        script: |
          cd ios
          pod install
          cd ..
          
      - name: Start iOS Simulator
        script: |
          xcrun simctl boot "iPhone 15" # Using iPhone 15 from the list
          xcrun simctl list devices
          flutter devices
          
      - name: Run Patrol tests
        script: |
          patrol test integration_test/successful_login_test.dart -d "iPhone 15" --debug
          
    artifacts:
      - patrol-results/**/*.png
      - patrol-results/**/*.xml
      - patrol-results/**/video.mp4